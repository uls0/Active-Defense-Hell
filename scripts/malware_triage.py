import os
import hashlib
import magic # Requiere python-magic
import requests

def get_file_hash(filepath):
    sha256_hash = hashlib.sha256()
    with open(filepath, "rb") as f:
        for byte_block in iter(lambda: f.read(4096), b""):
            sha256_hash.update(byte_block)
    return sha256_hash.hexdigest()

def perform_triage(filepath, vt_api_key=None):
    """Realiza un análisis rápido de la muestra capturada"""
    results = {
        "filename": os.path.basename(filepath),
        "hash": get_file_hash(filepath),
        "type": "Unknown",
        "verdict": "SUSPICIOUS"
    }
    
    # 1. Identificar tipo de archivo
    try:
        results["type"] = magic.from_file(filepath)
    except: pass

    # 2. Consultar VirusTotal (solo por Hash para no quemar cuota)
    if vt_api_key:
        url = f"https://www.virustotal.com/api/v3/files/{results['hash']}"
        headers = {"x-apikey": vt_api_key}
        try:
            r = requests.get(url, headers=headers, timeout=5)
            if r.status_code == 200:
                data = r.json()
                stats = data['data']['attributes']['last_analysis_stats']
                results["verdict"] = f"MALICIOUS ({stats['malicious']} detections)"
            elif r.status_code == 404:
                results["verdict"] = "NEW_SAMPLE (Not seen by VT)"
        except: pass

    # 3. Guardar reporte de triage
    report_path = filepath + ".triage.txt"
    with open(report_path, "w") as f:
        f.write(f"HELL MALWARE TRIAGE REPORT
")
        f.write(f"==========================
")
        f.write(f"File: {results['filename']}
")
        f.write(f"SHA256: {results['hash']}
")
        f.write(f"Type: {results['type']}
")
        f.write(f"Verdict: {results['verdict']}
")
    
    print(f"[☣️] Triage completado para {results['filename']}: {results['verdict']}")
    return results
