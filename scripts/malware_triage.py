import os
import hashlib
import requests
import time

def save_sample(data, ip):
    """Guarda físicamente la muestra capturada en la jaula de malware"""
    malware_dir = "logs/malware"
    os.makedirs(malware_dir, exist_ok=True)
    ts = int(time.time())
    filepath = os.path.join(malware_dir, f"sample_{ip}_{ts}.bin")
    with open(filepath, "wb") as f:
        f.write(data)
    print(f"[☣️] Sample saved: {filepath}")
    return filepath

def get_file_hash(filepath):
    sha256_hash = hashlib.sha256()
    with open(filepath, "rb") as f:
        for byte_block in iter(lambda: f.read(4096), b""):
            sha256_hash.update(byte_block)
    return sha256_hash.hexdigest()

def perform_triage(filepath, vt_api_key=None):
    """Realiza un análisis estático y consulta reputación"""
    if not os.path.exists(filepath): return
    
    file_hash = get_file_hash(filepath)
    report_path = filepath + ".triage.txt"
    
    verdict = "SUSPICIOUS_CONTENT"
    
    # Simulación de consulta a VT (o real si hay KEY)
    if vt_api_key:
        try:
            url = f"https://www.virustotal.com/api/v3/files/{file_hash}"
            r = requests.get(url, headers={"x-apikey": vt_api_key}, timeout=5)
            if r.status_code == 200:
                stats = r.json()['data']['attributes']['last_analysis_stats']
                verdict = f"KNOWN_MALWARE ({stats['malicious']} hits)"
            else:
                verdict = "NEW_UNSEEN_SAMPLE"
        except: pass

    with open(report_path, "w") as f:
        f.write(f"HELL TRIAGE REPORT\nIP: {os.path.basename(filepath).split('_')[1]}\nSHA256: {file_hash}\nVerdict: {verdict}\n")
    
    print(f"[☣️] Triage Report generated: {verdict}")
